"""
Data models for the heating control system
"""
from datetime import datetime
from typing import Optional, Dict, Any, List
from pydantic import BaseModel, Field
from enum import Enum


class ThermostatMode(str, Enum):
    """Thermostat operating modes for TRVZB"""
    OFF = "off"
    HEAT = "heat"
    AUTO = "auto"


class ThermostatState(BaseModel):
    """Represents the current state of a thermostat"""
    entity_id: str
    friendly_name: Optional[str] = None
    current_temperature: Optional[float] = None
    target_temperature: Optional[float] = None
    mode: Optional[str] = None  # off, heat, auto
    preset_mode: Optional[str] = None
    battery: Optional[int] = None
    available: bool = True
    last_updated: Optional[datetime] = None
    attributes: Dict[str, Any] = Field(default_factory=dict)
    
    class Config:
        json_encoders = {
            datetime: lambda v: v.isoformat() if v else None
        }


class SensorState(BaseModel):
    """Represents the current state of a temperature or humidity sensor"""
    entity_id: str
    friendly_name: Optional[str] = None
    state: Optional[float] = None  # The sensor value (temperature or humidity)
    unit: Optional[str] = None  # °C, °F, %
    available: bool = True
    last_updated: Optional[datetime] = None
    attributes: Dict[str, Any] = Field(default_factory=dict)
    
    class Config:
        json_encoders = {
            datetime: lambda v: v.isoformat() if v else None
        }


class Zone(BaseModel):
    """Represents a heating zone"""
    id: str
    name: str
    thermostats: List[str] = Field(default_factory=list)
    temperature_sensors: List[str] = Field(default_factory=list)
    humidity_sensors: List[str] = Field(default_factory=list)
    active_schedule: Optional[str] = None
    enabled: bool = True


class WeeklySchedule(BaseModel):
    """Weekly schedule in TRVZB format"""
    monday: str = "00:00/17"
    tuesday: str = "00:00/17"
    wednesday: str = "00:00/17"
    thursday: str = "00:00/17"
    friday: str = "00:00/17"
    saturday: str = "00:00/17"
    sunday: str = "00:00/17"


class Schedule(BaseModel):
    """Heating schedule definition"""
    id: str
    name: str
    description: Optional[str] = None
    enabled: bool = True
    weekly_schedule: WeeklySchedule
    created_at: Optional[datetime] = None
    updated_at: Optional[datetime] = None
    
    class Config:
        json_encoders = {
            datetime: lambda v: v.isoformat() if v else None
        }


class SystemMode(str, Enum):
    """High-level system operating modes"""
    AUTO = "auto"
    STAY_HOME = "stay_home"
    HOLIDAY = "holiday"
    TIMER = "timer"
    MANUAL = "manual"


class ConnectionStatus(str, Enum):
    """Home Assistant connection status"""
    CONNECTED = "connected"
    CONNECTING = "connecting"
    DISCONNECTED = "disconnected"
    ERROR = "error"


class SystemState(BaseModel):
    """Overall system state"""
    system_mode: SystemMode = SystemMode.MANUAL
    connection_status: ConnectionStatus = ConnectionStatus.DISCONNECTED
    last_updated: datetime = Field(default_factory=datetime.now)
    thermostats: Dict[str, ThermostatState] = Field(default_factory=dict)
    temperature_sensors: Dict[str, SensorState] = Field(default_factory=dict)
    humidity_sensors: Dict[str, SensorState] = Field(default_factory=dict)
    zones: Dict[str, Zone] = Field(default_factory=dict)
    
    class Config:
        json_encoders = {
            datetime: lambda v: v.isoformat() if v else None
        }


class StatusResponse(BaseModel):
    """API response for /api/status endpoint"""
    system_mode: str
    connection_status: str
    last_updated: datetime
    thermostats: List[ThermostatState]
    temperature_sensors: List[SensorState]
    humidity_sensors: List[SensorState]
    zones: List[Zone]
    
    class Config:
        json_encoders = {
            datetime: lambda v: v.isoformat() if v else None
        }
